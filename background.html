<script>
// Disable Gear icon by Yusuke Kamiyamane

var incognito;
var url;
var setting;
var forbiddenOrigin = /(chrome\:\/\/)/g;
var matchForbiddenOrigin;
var extractHostName = new RegExp('^(?:f|ht)tp(?:s)?\://([^/]+)', 'im');

function updateIcon(setting) {
    chrome.browserAction.setIcon({path:"icon-" + setting + ".png"});
}

function getSettings() {
  chrome.tabs.getSelected(undefined, function(tab) {
    incognito = tab.incognito;
    url = tab.url;
		
		chrome.experimental.contentSettings.javascript.get({
			'primaryUrl': url,
			'incognito': incognito
		},
		function(details) {
			matchForbiddenOrigin = url.match(forbiddenOrigin,'');
			matchForbiddenOrigin ? updateIcon("inactive") : updateIcon(details.setting);
		});
  });
}

function settingChanged() {
	if (!matchForbiddenOrigin) {
		var pattern = /^file:/.test(url) ? url : url.match(extractHostName)[0]+'/*';		
		// old method : url.replace(/\/[^\/]*?$/, '/*')
		
		chrome.experimental.contentSettings.javascript.get({
			'primaryUrl': url,
			'incognito': incognito
		},
		function(details) {
			setting = details.setting;
			
			if (setting) {
				var newSetting = (setting == 'allow' ? 'block' : 'allow'); 
				
				chrome.experimental.contentSettings.javascript.set({
					'primaryPattern': pattern,
					'setting': newSetting,
					'scope': (incognito ? 'incognito_session_only' : 'regular')
				});
				
				updateIcon(newSetting);
				console.info("javascript is now "+newSetting+"ed");
			}
			else {
				console.error("error, the setting is "+setting);
			}
		});
	}
	else {
		console.error("You can't disable javascript on "+url);
	}
}

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
	// Prevent multiple calls
	if (changeInfo.status == "loading" && tab.selected) {
		getSettings();
	}
});

chrome.tabs.onSelectionChanged.addListener(getSettings);
chrome.browserAction.onClicked.addListener(settingChanged);
</script>